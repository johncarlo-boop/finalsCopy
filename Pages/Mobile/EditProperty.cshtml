@page
@model PropertyInventory.Pages.Mobile.EditPropertyModel
@{
    ViewData["Title"] = "Edit Property";
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - Property Inventory</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <style>
        body {
            background-color: #f5f5f5;
            padding-bottom: 80px;
        }
        .form-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .navbar-mobile {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid #ddd;
            padding: 10px;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark bg-primary">
        <div class="container-fluid">
            <a href="/Mobile/Dashboard" class="navbar-brand mb-0 h1">‚Üê Back</a>
        </div>
    </nav>

    <div class="container-fluid mt-3">
        <div class="form-container">
            <h5 class="mb-3">Edit Property</h5>
            
            @if (TempData["SuccessMessage"] != null)
            {
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                    <i class="bi bi-check-circle"></i> @TempData["SuccessMessage"]
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            }
            
            @if (!string.IsNullOrEmpty(Model.ErrorMessage))
            {
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <i class="bi bi-exclamation-circle"></i> @Model.ErrorMessage
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            }

            @if (Model.Property != null)
            {
                <form method="post">
                    <input type="hidden" asp-for="Property.Id" />
                    <input type="hidden" asp-for="Property.PropertyCode" />
                    <input type="hidden" asp-for="Property.PropertyName" />
                    <input type="hidden" asp-for="Property.Category" />
                    <input type="hidden" asp-for="Property.Description" />
                    <input type="hidden" asp-for="Property.SerialNumber" />
                    <input type="hidden" asp-for="Property.ImageUrl" />
                    <input type="hidden" asp-for="Property.DateReceived" />
                    <input type="hidden" asp-for="Property.Quantity" />

                    <div class="mb-3">
                        <label class="form-label"><strong>Property Code:</strong></label>
                        <p class="form-control-plaintext">@Model.Property.PropertyCode</p>
                    </div>

                    <div class="mb-3">
                        <label class="form-label"><strong>Property Name:</strong></label>
                        <p class="form-control-plaintext">@Model.Property.PropertyName</p>
                    </div>

                    @if (Model.IndividualItems != null && Model.IndividualItems.Count > 0)
                    {
                        var borrowedCount = Model.IndividualItems.Count(i => i.Status == PropertyStatus.InUse && !string.IsNullOrEmpty(i.BorrowerName));
                        var editableCount = Model.IndividualItems.Count - borrowedCount;
                        
                        <div class="card mb-3">
                            <div class="card-header bg-info text-white">
                                <h6 class="mb-0"><i class="bi bi-list-ul"></i> Select Property to Edit (@Model.IndividualItems.Count @(Model.IndividualItems.Count == 1 ? "item" : "items"))</h6>
                                <small class="text-white-50">
                                    @if (borrowedCount > 0 && editableCount > 0)
                                    {
                                        <span>You can edit @editableCount available item(s). @borrowedCount borrowed item(s) cannot be edited until returned.</span>
                                    }
                                    else if (borrowedCount > 0)
                                    {
                                        <span>All items are currently borrowed. Please return them first to edit.</span>
                                    }
                                    else
                                    {
                                        <span>Click on a property from the table below to edit it</span>
                                    }
                                </small>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                    <table class="table table-sm table-hover table-bordered mb-0">
                                        <thead class="table-light sticky-top">
                                            <tr>
                                                <th>Tag Number</th>
                                                <th>Property Code</th>
                                                <th>Location</th>
                                                <th>Date Received</th>
                                                <th>Status</th>
                                                <th>Borrower</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var item in Model.IndividualItems.OrderBy(i => i.SerialNumber))
                                            {
                                                var isCurrentItem = item.Id == Model.Property?.Id;
                                                var isBorrowedItem = item.Status == PropertyStatus.InUse && !string.IsNullOrEmpty(item.BorrowerName);
                                                <tr class="@(isCurrentItem ? "table-primary" : (isBorrowedItem ? "table-secondary" : ""))" style="@(isCurrentItem ? "font-weight: bold;" : "")">
                                                    <td><strong>@(item.SerialNumber ?? "N/A")</strong></td>
                                                    <td>@item.PropertyCode</td>
                                                    <td>@item.Location</td>
                                                    <td>@(item.DateReceived?.ToString("MM/dd/yyyy") ?? "N/A")</td>
                                                    <td>
                                                        <span class="badge bg-@GetStatusColor(item.Status)">@item.Status</span>
                                                    </td>
                                                    <td>
                                                        @if (isBorrowedItem)
                                                        {
                                                            <span class="text-primary"><i class="bi bi-person-check"></i> @item.BorrowerName</span>
                                                        }
                                                        else
                                                        {
                                                            <span class="text-muted">-</span>
                                                        }
                                                    </td>
                                                    <td>
                                                        <div class="btn-group btn-group-sm" role="group">
                                                            @if (isBorrowedItem)
                                                            {
                                                                <button type="button" class="btn btn-outline-secondary" disabled title="This item is borrowed by @item.BorrowerName and cannot be edited. Please return it first.">
                                                                    <i class="bi bi-lock"></i> Locked
                                                                </button>
                                                            }
                                                            else
                                                            {
                                                                <a asp-page="/Mobile/EditProperty" asp-route-id="@item.Id" class="btn @(isCurrentItem ? "btn-warning" : "btn-outline-warning")" title="Edit this item">
                                                                    <i class="bi bi-pencil"></i> @(isCurrentItem ? "Editing" : "Edit")
                                                                </a>
                                                            }
                                                            @if (item.Status != PropertyStatus.InUse)
                                                            {
                                                                <a asp-page="/Mobile/Borrow" asp-route-id="@item.Id" class="btn btn-outline-success" title="Borrow this item">
                                                                    <i class="bi bi-handbag"></i> Borrow
                                                                </a>
                                                            }
                                                            else
                                                            {
                                                                <button type="submit" asp-page-handler="Return" asp-route-propertyId="@item.Id" class="btn btn-outline-danger" title="Return this item" onclick="return confirm('Are you sure you want to return this item?');" formnovalidate>
                                                                    <i class="bi bi-arrow-counterclockwise"></i> Return
                                                                </button>
                                                            }
                                                        </div>
                                                    </td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    }

                    @{
                        var isBorrowed = Model.Property!.Status == PropertyStatus.InUse && !string.IsNullOrWhiteSpace(Model.Property.BorrowerName);
                    }
                    
                    @if (isBorrowed)
                    {
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle"></i> <strong>This property is currently borrowed by @Model.Property.BorrowerName.</strong> Please return it first before editing.
                        </div>
                    }

                    <div class="mb-3">
                        <label asp-for="Property.Location" class="form-label">Location *</label>
                        <input asp-for="Property.Location" class="form-control" value="@(Model.Property?.Location ?? "")" required disabled="@isBorrowed" />
                        <span asp-validation-for="Property.Location" class="text-danger"></span>
                    </div>

                    <div class="mb-3">
                        <label asp-for="Property.Status" class="form-label">Status *</label>
                        <select asp-for="Property.Status" class="form-select" required disabled="@isBorrowed">
                            <option value="Available" selected="@(Model.Property?.Status == PropertyStatus.Available)">Available</option>
                            <option value="InUse" selected="@(Model.Property?.Status == PropertyStatus.InUse)">In Use</option>
                            <option value="UnderMaintenance" selected="@(Model.Property?.Status == PropertyStatus.UnderMaintenance)">Under Maintenance</option>
                            <option value="Damaged" selected="@(Model.Property?.Status == PropertyStatus.Damaged)">Damaged</option>
                        </select>
                        <span asp-validation-for="Property.Status" class="text-danger"></span>
                    </div>

                    <div class="mb-3">
                        <label asp-for="Property.Remarks" class="form-label">Remarks</label>
                        <textarea asp-for="Property.Remarks" class="form-control" rows="3" disabled="@isBorrowed">@(Model.Property?.Remarks ?? "")</textarea>
                        <span asp-validation-for="Property.Remarks" class="text-danger"></span>
                    </div>

                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary" disabled="@isBorrowed">Save Changes</button>
                        <a href="/Mobile/Dashboard" class="btn btn-outline-secondary">Cancel</a>
                    </div>
                </form>
            }
            else
            {
                <div class="alert alert-warning">Property not found.</div>
                <a href="/Mobile/Dashboard" class="btn btn-primary">Back to Dashboard</a>
            }
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>

@functions {
    private string GetStatusColor(PropertyStatus status)
    {
        return status switch
        {
            PropertyStatus.Available => "success",
            PropertyStatus.InUse => "primary",
            PropertyStatus.UnderMaintenance => "warning",
            PropertyStatus.Damaged => "danger",
            _ => "secondary"
        };
    }
}

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
}







