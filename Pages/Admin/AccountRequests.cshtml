@page
@model PropertyInventory.Pages.Admin.AccountRequestsModel
@using PropertyInventory.Models
@using System.Text.Json
@{
    ViewData["Title"] = "Account Requests";
    var notificationSeed = JsonSerializer.Serialize(
        Model.AccountRequests.Select(r => new
        {
            title = r.Status switch
            {
                AccountRequestStatus.Approved => "Account Request Approved",
                AccountRequestStatus.Rejected => "Account Request Rejected",
                _ => "Pending Account Request"
            },
            message = $"{r.FullName} ({r.Email}) - {r.Status}",
            type = r.Status switch
            {
                AccountRequestStatus.Approved => "success",
                AccountRequestStatus.Rejected => "danger",
                _ => "warning"
            },
            timestamp = r.RequestedAt
        }),
        new JsonSerializerOptions(JsonSerializerDefaults.Web)
    );
}

<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Account Requests</h2>
        <div>
            <button type="button" class="btn btn-primary me-2" data-bs-toggle="modal" data-bs-target="#requestAccountModal">
                <i class="bi bi-person-plus"></i> Request Account
            </button>
            <a asp-page="/Index" class="btn btn-outline-secondary">Back to Dashboard</a>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="card stats-card text-white bg-success h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <p class="text-white-50 mb-1">Approved Users</p>
                            <h2 class="mb-0">@Model.ApprovedCount</h2>
                        </div>
                        <i class="bi bi-check2-circle stats-icon"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stats-card text-white bg-warning h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <p class="text-white-50 mb-1">Pending Requests</p>
                            <h2 class="mb-0">@Model.PendingCount</h2>
                        </div>
                        <i class="bi bi-hourglass-split stats-icon"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stats-card text-white bg-danger h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <p class="text-white-50 mb-1">Rejected Requests</p>
                            <h2 class="mb-0">@Model.RejectedCount</h2>
                        </div>
                        <i class="bi bi-x-octagon stats-icon"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stats-card text-white bg-primary h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <p class="text-white-50 mb-1">Total Requests</p>
                            <h2 class="mb-0">@Model.TotalRequests</h2>
                        </div>
                        <i class="bi bi-people stats-icon"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="bi bi-check-circle"></i> @TempData["SuccessMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }
    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="bi bi-exclamation-circle"></i> @TempData["ErrorMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <div class="card shadow-sm mb-4">
        <div class="card-header bg-white">
            <div class="d-flex flex-column flex-lg-row align-items-lg-center justify-content-between gap-3">
                <div>
                    <h5 class="mb-0"><i class="bi bi-kanban"></i> Account Requests Board</h5>
                    <small class="text-muted">Review pending users, active accounts, and rejected requests at a glance.</small>
                </div>
                <ul class="nav nav-pills request-tabs" id="requestTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="pending-tab" data-bs-toggle="pill" data-bs-target="#pendingTab" type="button" role="tab">
                            Pending <span class="badge bg-light text-dark">@Model.PendingCount</span>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="approved-tab" data-bs-toggle="pill" data-bs-target="#approvedTab" type="button" role="tab">
                            Approved <span class="badge bg-light text-dark">@Model.ApprovedCount</span>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="rejected-tab" data-bs-toggle="pill" data-bs-target="#rejectedTab" type="button" role="tab">
                            Rejected <span class="badge bg-light text-dark">@Model.RejectedCount</span>
                        </button>
                    </li>
                </ul>
            </div>
        </div>
        <div class="card-body">
            <div class="tab-content" id="requestTabsContent">
                <div class="tab-pane fade show active" id="pendingTab" role="tabpanel" aria-labelledby="pending-tab">
                    @if (!Model.PendingRequests.Any())
                    {
                        <div class="alert alert-info text-center">
                            <i class="bi bi-info-circle"></i> No pending requests at the moment.
                        </div>
                    }
                    else
                    {
                        <div class="row g-3">
                            @foreach (var request in Model.PendingRequests)
                            {
                                <div class="col-xl-4 col-lg-6">
                                    <div class="card request-card border-warning h-100">
                                        <div class="card-body d-flex flex-column">
                                            <div class="d-flex justify-content-between align-items-start">
                                                <div>
                                                    <h5 class="card-title mb-1">@request.FullName</h5>
                                                    <span class="badge bg-warning text-dark"><i class="bi bi-hourglass-split me-1"></i> Pending</span>
                                                </div>
                                                <small class="text-muted">@request.RequestedAt.ToLocalTime().ToString("MMM dd, yyyy hh:mm tt")</small>
                                            </div>
                                            <p class="text-muted small mb-2"><i class="bi bi-envelope"></i> @request.Email</p>
                                            <p class="mb-3">
                                                <i class="bi bi-briefcase me-1"></i>
                                                @(string.IsNullOrWhiteSpace(request.Position) ? "No position provided." : request.Position)
                                            </p>
                                            <div class="d-flex flex-column gap-2 mt-auto">
                                                <form method="post" asp-page-handler="">
                                                    <input type="hidden" name="requestId" value="@request.Id" />
                                                    <button type="submit" name="action" value="approve" class="btn btn-success w-100"
                                                            onclick="return confirm('Approve access for @request.FullName?');">
                                                        <i class="bi bi-check2-circle"></i> Approve & Activate
                                                    </button>
                                                </form>
                                                <button type="button" class="btn btn-outline-danger w-100"
                                                        data-bs-toggle="modal" data-bs-target="#rejectModal_@request.Id">
                                                    <i class="bi bi-x-circle"></i> Reject Request
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="modal fade" id="rejectModal_@request.Id" tabindex="-1" aria-hidden="true">
                                    <div class="modal-dialog">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title">Reject @request.FullName</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                            </div>
                                            <form method="post" asp-page-handler="">
                                                <div class="modal-body">
                                                    <input type="hidden" name="requestId" value="@request.Id" />
                                                    <div class="mb-3">
                                                        <label for="rejectionReason_@request.Id" class="form-label">Reason (optional)</label>
                                                        <textarea name="rejectionReason" id="rejectionReason_@request.Id" class="form-control" rows="3"
                                                                  placeholder="Provide more context for this decision..."></textarea>
                                                    </div>
                                                </div>
                                                <div class="modal-footer">
                                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                                    <button type="submit" name="action" value="reject" class="btn btn-danger">
                                                        <i class="bi bi-x-circle"></i> Reject Request
                                                    </button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                </div>
                <div class="tab-pane fade" id="approvedTab" role="tabpanel" aria-labelledby="approved-tab">
                    @if (!Model.ApprovedRequests.Any())
                    {
                        <div class="alert alert-light border text-center">
                            <i class="bi bi-person-check"></i> No approved users yet.
                        </div>
                    }
                    else
                    {
                        <div class="row g-3">
                            @foreach (var request in Model.ApprovedRequests)
                            {
                                <div class="col-xl-4 col-lg-6">
                                    <div class="card request-card border-success h-100">
                                        <div class="card-body d-flex flex-column">
                                            <div class="d-flex justify-content-between align-items-start">
                                                <div>
                                                    <h5 class="card-title mb-1">@request.FullName</h5>
                                                    <span class="badge bg-success"><i class="bi bi-shield-check me-1"></i> Active User</span>
                                                </div>
                                                <small class="text-muted">Approved @((request.ReviewedAt ?? request.RequestedAt).ToLocalTime().ToString("MMM dd, yyyy"))</small>
                                            </div>
                                            <p class="text-muted small mb-2"><i class="bi bi-envelope"></i> @request.Email</p>
                                            <p class="text-muted small mb-2">
                                                <i class="bi bi-person-check-fill me-1"></i>
                                                Approved by @(string.IsNullOrWhiteSpace(request.ReviewedBy) ? "Admin" : request.ReviewedBy)
                                            </p>
                                            <p class="mb-0 text-muted small">
                                                <i class="bi bi-briefcase me-1"></i>
                                                @(string.IsNullOrWhiteSpace(request.Position) ? "No position specified." : request.Position)
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                </div>
                <div class="tab-pane fade" id="rejectedTab" role="tabpanel" aria-labelledby="rejected-tab">
                    @if (!Model.RejectedRequests.Any())
                    {
                        <div class="alert alert-light border text-center">
                            <i class="bi bi-person-x"></i> No rejected requests.
                        </div>
                    }
                    else
                    {
                        <div class="row g-3">
                            @foreach (var request in Model.RejectedRequests)
                            {
                                <div class="col-xl-4 col-lg-6">
                                    <div class="card request-card border-danger h-100">
                                        <div class="card-body d-flex flex-column">
                                            <div class="d-flex justify-content-between align-items-start">
                                                <div>
                                                    <h5 class="card-title mb-1">@request.FullName</h5>
                                                    <span class="badge bg-danger"><i class="bi bi-x-octagon me-1"></i> Rejected</span>
                                                </div>
                                                <small class="text-muted">Reviewed @((request.ReviewedAt ?? request.RequestedAt).ToLocalTime().ToString("MMM dd, yyyy"))</small>
                                            </div>
                                            <p class="text-muted small mb-2"><i class="bi bi-envelope"></i> @request.Email</p>
                                            <p class="mb-2">
                                                <i class="bi bi-chat-left-text me-1"></i>
                                                @(string.IsNullOrWhiteSpace(request.RejectionReason) ? "No rejection reason recorded." : request.RejectionReason)
                                            </p>
                                            <p class="text-muted small mb-0">
                                                <i class="bi bi-person-dash me-1"></i>
                                                Reviewed by @(string.IsNullOrWhiteSpace(request.ReviewedBy) ? "Admin" : request.ReviewedBy)
                                            </p>
                                            <div class="mt-3">
                                                <button type="button" class="btn btn-outline-danger w-100 btn-sm" 
                                                        onclick="confirmDeleteRequest('@request.Id', '@request.FullName')">
                                                    <i class="bi bi-trash"></i> Delete Request
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <div class="card shadow-sm">
        <div class="card-header d-flex justify-content-between align-items-center">
            <div>
                <h5 class="mb-0"><i class="bi bi-activity"></i> Account Request Activity</h5>
                <small class="text-muted">Complete history of all account requests. Remove entries to clean up.</small>
            </div>
            <span class="badge bg-primary">@Model.TotalRequests total</span>
        </div>
        <div class="card-body p-0">
            @if (!Model.AccountRequests.Any())
            {
                <div class="alert alert-info text-center m-3">
                    <i class="bi bi-info-circle"></i> No account request history yet.
                </div>
            }
            else
            {
                <div class="table-responsive" style="max-height: 600px; overflow-y: auto;">
                    <table class="table table-striped table-hover mb-0">
                        <thead class="table-light sticky-top">
                            <tr>
                                <th>Request ID</th>
                                <th>Full Name</th>
                                <th>Email</th>
                                <th>Status</th>
                                <th>Requested At</th>
                                <th>Reviewed By</th>
                                <th>Position</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var request in Model.AccountRequests)
                            {
                                var badgeColor = GetAccountRequestStatusColor(request.Status);
                                <tr>
                                    <td><strong>@request.Id.Substring(0, Math.Min(8, request.Id.Length))</strong></td>
                                    <td>@request.FullName</td>
                                    <td>@request.Email</td>
                                    <td>
                                        <span class="badge bg-@badgeColor">
                                            @request.Status
                                        </span>
                                    </td>
                                    <td>@request.RequestedAt.ToLocalTime().ToString("MM/dd/yyyy HH:mm")</td>
                                    <td>
                                        @if (!string.IsNullOrWhiteSpace(request.ReviewedBy))
                                        {
                                            <span class="text-muted small">
                                                <i class="bi bi-person-check me-1"></i>@request.ReviewedBy
                                            </span>
                                        }
                                        else
                                        {
                                            <span class="text-muted">-</span>
                                        }
                                    </td>
                                    <td>
                                        @if (!string.IsNullOrWhiteSpace(request.Position))
                                        {
                                            <span class="text-muted small" title="@request.Position">
                                                @(request.Position.Length > 30 ? request.Position.Substring(0, 30) + "..." : request.Position)
                                            </span>
                                        }
                                        else if (request.Status == AccountRequestStatus.Rejected && !string.IsNullOrWhiteSpace(request.RejectionReason))
                                        {
                                            <span class="text-danger small" title="@request.RejectionReason">
                                                <i class="bi bi-chat-left-quote me-1"></i>@(request.RejectionReason.Length > 30 ? request.RejectionReason.Substring(0, 30) + "..." : request.RejectionReason)
                                            </span>
                                        }
                                        else
                                        {
                                            <span class="text-muted">-</span>
                                        }
                                    </td>
                                    <td>
                                        <button type="button" class="btn btn-outline-danger btn-sm"
                                                onclick="confirmDeleteRequest('@request.Id', '@request.FullName')">
                                            <i class="bi bi-trash"></i> Delete
                                        </button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        </div>
    </div>

    <!-- Delete Request Modal -->
    <div class="modal fade" id="deleteRequestModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirm Deletion</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete the account request for <strong id="deleteRequestName"></strong>?</p>
                    <p class="text-danger small mb-0"><i class="bi bi-exclamation-triangle"></i> This action cannot be undone.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <form method="post" asp-page-handler="Delete">
                        <input type="hidden" name="id" id="deleteRequestId" />
                        <button type="submit" class="btn btn-danger">Delete Request</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Request Account Modal -->
    <div class="modal fade" id="requestAccountModal" tabindex="-1" aria-labelledby="requestAccountModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="requestAccountModalLabel">
                        <i class="bi bi-person-plus"></i> Request New Account
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form method="post" asp-page-handler="RequestAccount">
                    <div class="modal-body">
                        <p class="text-muted mb-3">Fill out the form below to request an account. An admin will review the request.</p>
                        
                        <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>
                        
                        <div class="mb-3">
                            <label asp-for="Input.FullName" class="form-label">Full Name *</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-person"></i></span>
                                <input asp-for="Input.FullName" class="form-control" placeholder="Enter full name" required />
                            </div>
                            <span asp-validation-for="Input.FullName" class="text-danger"></span>
                        </div>

                        <div class="mb-3">
                            <label asp-for="Input.Email" class="form-label">Email *</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-envelope"></i></span>
                                <input asp-for="Input.Email" class="form-control" type="email" placeholder="Enter email address" required />
                            </div>
                            <span asp-validation-for="Input.Email" class="text-danger"></span>
                        </div>

                        <div class="mb-3">
                            <label asp-for="Input.Position" class="form-label">Position</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-briefcase"></i></span>
                                <input asp-for="Input.Position" class="form-control" placeholder="e.g., Teacher, Staff, Administrator" />
                            </div>
                            <span asp-validation-for="Input.Position" class="text-danger"></span>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-send"></i> Submit Request
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function confirmDeleteRequest(requestId, requestName) {
            document.getElementById('deleteRequestId').value = requestId;
            document.getElementById('deleteRequestName').textContent = requestName;
            new bootstrap.Modal(document.getElementById('deleteRequestModal')).show();
        }

        document.addEventListener('DOMContentLoaded', function () {
            const historyNotifications = @Html.Raw(notificationSeed);
            if (window.NotificationCenter && Array.isArray(historyNotifications) && historyNotifications.length) {
                window.NotificationCenter.bootstrap(historyNotifications);
            }
        });
    </script>
}

@functions {
    private string GetAccountRequestStatusColor(AccountRequestStatus status)
    {
        return status switch
        {
            AccountRequestStatus.Pending => "warning",
            AccountRequestStatus.Approved => "success",
            AccountRequestStatus.Rejected => "danger",
            _ => "secondary"
        };
    }
}


